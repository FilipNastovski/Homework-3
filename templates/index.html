<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Stock Analysis</title>
    <link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='styles.css') }}">
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
</head>
<body>
    <div class="container">
        <h1>Stock Analysis App</h1>

        <!-- Dropdown for Issuer Codes -->
        <label for="issuerDropdown">Select Issuer Code:</label>
        <select id="issuerDropdown">
            <option value="">Select Issuer</option>
        </select>

        <!-- Dropdown for Time Period (Daily, Weekly, Monthly) -->
        <label for="timePeriodDropdown">Select Time Period:</label>
        <select id="timePeriodDropdown">
            <option value="daily">Daily</option>
            <option value="weekly">Weekly</option>
            <option value="monthly">Monthly</option>
        </select>

        <!-- Button for Scraping Data -->
        <button id="scrapeDataButton">Scrape Data</button>

        <!-- Button for Running Technical Analysis -->
        <button id="runAnalysisButton">Run Analysis</button>

        <!-- Button for Fetching Latest Data -->
        <button id="fetchDataButton">Fetch Data</button>

        <!-- Today's Analysis Table -->
        <h2>Today's Analysis</h2>
        <div id="todaysAnalysisContainer"></div>

        <!-- Historical Analysis Table -->
        <h2>Historical Analysis</h2>
        <div id="historicalAnalysisContainer"></div>
    </div>

    <script>
        $(document).ready(function() {
            // Fetch issuer codes on page load
            $.get('/get_issuer_codes', function(issuerCodes) {
                issuerCodes.forEach(function(code) {
                    $('#issuerDropdown').append(new Option(code, code));
                });
            });

            // Fetch data when clicking the Fetch Data button
            $('#fetchDataButton').click(function() {
                const issuerCode = $('#issuerDropdown').val();
                const timePeriod = $('#timePeriodDropdown').val();

                if (!issuerCode || !timePeriod) {
                    alert("Please select an issuer code and time period.");
                    return;
                }

                // Fetch latest analysis for the selected issuer and time period
                $.get(`/fetch_latest_analysis?issuer_code=${issuerCode}&time_period=${timePeriod}`, function(data) {
                    let output = "<table><thead><tr>";
                    Object.keys(data[0]).forEach(key => {
                        output += `<th>${key}</th>`;
                    });
                    output += "</tr></thead><tbody>";
                    data.forEach(row => {
                        output += "<tr>";
                        Object.keys(row).forEach(key => {
                            let value = row[key] === null ? "No Data" : row[key];
                            output += `<td>${value}</td>`;
                        });
                        output += "</tr>";
                    });
                    output += "</tbody></table>";
                    $('#todaysAnalysisContainer').html(output);

                    // Add the signal button
                    // Add the signal button
                    const signal = data[0].Signal;
                    let signalClass = "";
                    if (signal === "Buy") {
                        signalClass = "buy";
                    } else if (signal === "Sell") {
                        signalClass = "sell";
                    } else if (signal === "Hold") {  // Add condition for "Hold"
                        signalClass = "hold";
                    }
                    $('#todaysAnalysisContainer').append(`<div class="signal ${signalClass}">${signal}</div>`);

                }).fail((xhr) => {
                    alert(`Error: ${xhr.responseJSON?.message || "Failed to fetch latest analysis."}`);
                });

                // Fetch historical analysis data
                $.get(`/fetch_historical_analysis?issuer_code=${issuerCode}&time_period=${timePeriod}`, function(data) {
                    let output = "<table><thead><tr>";
                    Object.keys(data[0]).forEach(key => {
                        output += `<th>${key}</th>`;
                    });
                    output += "</tr></thead><tbody>";
                    data.forEach(row => {
                        output += "<tr>";
                        Object.keys(row).forEach(key => {
                            let value = row[key] === null ? "No Data" : row[key];
                            output += `<td>${value}</td>`;
                        });
                        output += "</tr>";
                    });
                    output += "</tbody></table>";
                    $('#historicalAnalysisContainer').html(output);
                }).fail((xhr) => {
                    alert(`Error: ${xhr.responseJSON?.message || "Failed to fetch historical analysis."}`);
                });
            });

            // Scrape Data button to run main.py
            $('#scrapeDataButton').click(function() {
                $.post('/scrape_data', function(response) {
                    alert(response.message);
                }).fail(function() {
                    alert("Error running scrape data script.");
                });
            });

            // Run Analysis button to run TechnicalAnalysis.py
            $('#runAnalysisButton').click(function() {
                $.post('/run_analysis', function(response) {
                    alert(response.message);
                }).fail(function() {
                    alert("Error running technical analysis script.");
                });
            });
        });
    </script>
</body>
</html>
